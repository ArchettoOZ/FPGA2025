# FPGA创新设计大赛 AMD赛道命题式赛道 - 设计报告

---

## 1. 项目概述

### 1.1 项目背景

本项目面向嵌入式边缘计算中的数值线性代数场景（如雷达/通信中的协方差估计、最小二乘与卡尔曼滤波等），在资源受限的 PYNQ-Z2 平台上实现对厄米正定矩阵的乔列斯基分解（Cholesky Decomposition）硬件加速器。通过将高复杂度的矩阵分解运算从 CPU 转移到 FPGA 上，实现低时延、低功耗与稳定吞吐的目标。

### 1.2 设计目标

本项目结合 Vitis HLS 对算法进行硬件结构化与资源/性能权衡优化，目标如下：

- 功能目标：
	- 对输入的厄米正定矩阵 A 进行下三角 Cholesky 分解，输出下三角矩阵 L，满足 A = L · L^H；支持复数定点输入输出流接口。
- 性能目标：
	- 在 7 ns 目标时钟周期下，单次分解在约 616–628 个时钟周期内完成，RTL 联合仿真通过；内层关键循环实现 II≈1–3 的流水线执行，具备稳定的启动间隔。
- 资源优化目标：
	- 在 xc7z020 上尽量避免使用片上 BRAM（当前版本使用 0 个 BRAM）；DSP 使用小于 10%（当前为 14 个，约 6%）；LUT 使用控制在 20% 左右（约 18%）。

### 1.3 技术规格

- 目标平台：AMD PYNQ-Z2（xc7z020-clg484-1）
- 开发工具：Vitis HLS 2024.2（Vivado IP Flow）
- 编程语言：C/C++（基于 AMD/Xilinx xf::solver L1 库）
- 接口协议：ap_ctrl_hs 控制，ap_fifo 数据流
- 时钟约束：7.0 ns（约 142.9 MHz）
- 验证环境：C 仿真（csim）+ RTL 联合仿真（cosim, Verilog/xsim）
- 顶层内核：kernel_cholesky_0（输入流 matrixAStrm，输出流 matrixLStrm）

---

## 2. 设计原理和功能框图

### 2.1 算法原理

对厄米正定矩阵 A 进行 Cholesky 分解，得到下三角矩阵 L，使得 A = L · L^H（H 表示共轭转置）。分解过程按列进行：

- 对角元：

$$
L_{kk} = \sqrt{\,A_{kk} - \sum_{j=0}^{k-1} L_{kj} \cdot \overline{L_{kj}}\,}\quad (k=0,1,\dots,n-1)
$$

- 斜对角元（第 k 列的第 i 行）：

$$
L_{ik} = \frac{1}{L_{kk}}\left( A_{ik} - \sum_{j=0}^{k-1} L_{ij}\cdot \overline{L_{kj}} \right)\quad (i=k+1,\dots,n-1)
$$

本设计使用复数定点数据类型 $x\_\text{complex}\langle ap\_fixed\langle 16,1\rangle\rangle$，通过定点乘加与平方根/除法单元完成上述运算，并在 HLS 中对内层求和与列更新循环进行流水化与适度展开，以提升吞吐与降低 II。

### 2.2 系统架构设计

#### 2.2.1 顶层架构

整体采用“流式输入 → 列分解计算 → 流式输出”的结构，控制协议为 ap_ctrl_hs：

```
┌──────────────────────────────────────────────────────┐
│                     kernel_cholesky_0                │
├──────────────┬─────────────────────┬─────────────────┤
│  输入模块     │    计算核心          │    输出模块      │
│  (ap_fifo)   │  · 对角计算 √ 和 1/√  │   (ap_fifo)     │
│ matrixAStrm  │  · 列更新乘加/除法     │ matrixLStrm     │
└──────────────┴─────────────────────┴─────────────────┘
	ap_start/ap_done/ap_idle/ap_ready（ap_ctrl_hs）
```

输入输出均为 32 bit 数据流，表示复数定点（实部 16 bit + 虚部 16 bit）。

#### 2.2.2 核心计算模块设计

核心由以下子模块/阶段构成（参考 HLS 绑定与综合报告）：

- 对角元素阶段：平方根与倒数计算（报告显示推断了 sqrt 与 sdiv 子模块，sqrt IP 延迟约 55 周期，定点除法序列延迟约 37 周期）。
- 列内更新阶段：对每个元素执行复数乘加与除法，内层求和循环采用流水化和部分展开以提高并行度。
- 内部缓冲：L_internal、diag_internal 等小容量数组采用 LUTRAM 实现，避免占用 BRAM。

#### 2.2.3 数据流图

```
matrixAStrm (复数定点流)
	↓ 解析/缓存（极小 LUTRAM）
	↓ 对角计算（平方根/倒数）
	↓ 列更新（复数乘加、定点除法）
	↓ 结果打拍
matrixLStrm (复数定点流)
```

### 2.3 接口设计

接口采用 HLS ap_fifo 流和 ap_ctrl_hs 控制，来自综合报告：

- 输入接口：matrixAStrm（ap_fifo, in, 32 bit），数据结构为 stream<x_complex<ap_fixed<16,1>>>。
- 输出接口：matrixLStrm（ap_fifo, out, 32 bit），数据结构同上。
- 控制接口：ap_ctrl_hs（ap_start/ap_done/ap_idle/ap_ready），时钟 ap_clk，复位 ap_rst。

该设计具备稳定的启动间隔，联合仿真报告显示 Interval≈617 周期（7 ns 时钟）。

---

## 3. 优化方向选择与原理

### 3.1 优化目标分析

根据赛题要求与器件资源，重点关注：

- [x] 减少片上存储（BRAM）使用（当前版本 BRAM=0）。
- [x] 提升流水线性能（降低 II / 稳定启动间隔）。
- [x] 提高性能/资源比（复数乘加用少量 DSP，尽量以 LUT 实现小存储）。

### 3.2 优化策略设计

#### 3.2.1 存储优化

优化原理：对内部行/列缓冲采用小深度数组并尽可能映射到 LUTRAM，同时对热点数组做循环维度分割以提高并发访存带宽。

具体措施（见 Pragma Report）：

- 对 L_internal、diag_internal 等数组使用 `#pragma HLS ARRAY_PARTITION cyclic dim=1 factor=2`，提升并发读写能力。
- 小容量数组（如 2～6 深度）保持为 `ram_1p/ram_2p`，由综合工具优先映射至 LUTRAM，避免 BRAM 消耗。
- 流接口（ap_fifo）承接片外/上游数据流，减少片上大缓存需求。

#### 3.2.2 流水线优化

优化原理：在内层求和与列更新环节插入流水线，必要时做小因子展开；通过依赖分析与 `dependence` 指令消除伪相关；在不同阶段之间使用轻量打拍以稳定启动间隔。

具体措施：

- `#pragma HLS PIPELINE II=1` 用于内层关键循环与子核（如 choleskyalt2/matrixmultiply 部分），实际达到 II≈1–3（报告显示 sum_loop II=1，若干 VITIS_LOOP II=3）。
- `#pragma HLS UNROLL factor=2` 在列内更新处做小规模展开，提高并行乘加数量。
- `#pragma HLS dependence variable=L_internal inter false` 去除跨迭代的虚假相关，避免阻碍流水线推进。

#### 3.2.3 并行化优化

优化原理：在列更新中并行执行若干复数乘加，利用 DSP 资源进行乘法，LUT 完成加/控制，平衡时序与面积。

具体措施：

- 数据级并行：对乘加通道做因子为 2 的展开；
- 指令级并行：乘法映射至 DSP（报告显示 DSP=14，约 6%），加法器与控制逻辑使用 LUT/FF；
- 通过数据流/打拍保证各阶段在 7 ns 约束下满足时序与间隔。

### 3.3 HLS指令优化

关键 HLS 指令（节选自综合报告）：

```cpp
#pragma HLS PIPELINE II=1
#pragma HLS UNROLL factor=2
#pragma HLS ARRAY_PARTITION variable=L_internal cyclic dim=1 factor=2
#pragma HLS ARRAY_PARTITION variable=diag_internal cyclic dim=1 factor=2
#pragma HLS ARRAY_PARTITION variable=A cyclic dim=1 factor=2
#pragma HLS ARRAY_PARTITION variable=L cyclic dim=1 factor=2
#pragma HLS dependence variable=L_internal inter false
```

---

## 4. LLM 辅助优化记录

### 4.1 优化阶段一：内层求和与列更新流水化

#### 4.1.1 优化目标

降低列更新中内层求和的 II，提升单列处理吞吐，确保在 7 ns 时钟下满足时序。

#### 4.1.2 Prompt 设计

用户输入（摘要）：

```
我在 PYNQ-Z2 上做 Cholesky 分解（复数定点），内层求和与列更新存在数据相关，
II 未稳定到 1。如何通过数组分割与小因子展开在不增加 BRAM 的前提下提升吞吐？
目标时钟 7 ns，尽量减少 DSP 使用。
```

#### 4.1.3 LLM 回答

模型建议要点：

- 对热点数组（L_internal、diag_internal）做 cyclic 分割，优先 LUTRAM，实现并发读写；
- 在求和环节 `#pragma HLS PIPELINE II=1`，若仍受端口带宽限制则 `UNROLL factor=2`；
- 对可能的伪相关使用 `#pragma HLS dependence inter false`；
- 保持 ap_fifo 流接口以减少片上大缓存，避免 BRAM 增长。

#### 4.1.4 优化实施

采用的建议：

- 在内层 sum/更新循环加入 `PIPELINE II=1`，列更新处做 `UNROLL factor=2`；
- 对 L_internal、diag_internal 使用 `ARRAY_PARTITION cyclic dim=1 factor=2`；
- 增加 `dependence inter false` 以消除伪相关。

实施效果（当前版本，见综合/仿真报告）：

- 内层 sum_loop 达到 II=1；若干 VITIS_LOOP 稳定在 II≈3；
- BRAM 使用为 0；
- RTL cosim：Latency≈616 周期，Interval≈617 周期（7 ns 时钟）。

### 4.2 优化阶段二：算术单元延迟隐藏与资源均衡

#### 4.2.1 优化目标

在引入 sqrt/div 等长延迟单元后，保持时序与稳定启动间隔，避免 BRAM 增长与过度 DSP 消耗。

#### 4.2.2 Prompt 设计

用户输入（摘要）：

```
综合报告显示 sqrt IP 延迟约 55 周期，sdiv 延迟约 37 周期。如何在 7 ns 目标下
隐藏这些延迟并尽量维持较小的启动间隔，同时保持 BRAM=0？
```

#### 4.2.3 LLM 回答

模型建议要点：

- 将对角计算与列更新解耦，通过轻量级寄存器打拍，在数据依赖允许时前推后延；
- 维持列内 `UNROLL factor=2` 的乘加并行度，避免过多 DSP；
- 尽量使用 LUTRAM 小缓存，避免引入更大深度导致 BRAM 推断；
- 在必要的循环处标注 tripcount，帮助调度器估算并优化流水线调度。

#### 4.2.4 优化实施

- 保持小规模展开与流水线；
- 在关键循环添加 tripcount 注解（参考库内宏），帮助工具优化排程；
- 最终达到 Interval≈617 周期的稳定启动间隔，满足 7 ns 约束。

### 4.3 其他阶段（略）

### 4.4 LLM 辅助优化总结

总体收益：

- 在不使用 BRAM 的条件下实现稳定流水，Interval≈617 周期；
- 使用少量 DSP（14/220 ≈ 6%）实现复数乘法；
- 显著减少人工反复试错时间，快速锁定 `PIPELINE/UNROLL/ARRAY_PARTITION` 的有效组合。

经验总结：

- Prompt 要尽量明确“带宽瓶颈（端口数）”与“数据相关”来源，便于给出 array_partition 与 dependence 的针对性建议；
- LLM 的建议需配合 HLS 报告验证，尤其关注生成的 IP 延迟对 II 的影响；
- 对小容量缓冲，优先 LUTRAM 是降低 BRAM 的关键。

---

## 5. 优化前后性能与资源对比报告

### 5.1 测试环境

- 硬件平台：AMD PYNQ-Z2（xc7z020-clg484-1）
- 软件版本：Vitis HLS 2024.2
- 测试数据集：随机生成的厄米正定矩阵（复数定点，尺寸与 L1 测试一致）
- 评估指标：资源（BRAM/DSP/LUT/FF）、Latency、Interval、时钟周期、正确性（csim/cosim）

### 5.2 综合结果对比

#### 5.2.1 资源使用对比

注：未保留早期“优化前”基线统计，以下列出当前版本（综合报告）达成值。

| 资源类型 | 优化前 | 优化后 | 改善幅度 | 利用率(优化前) | 利用率(优化后) |
| -------- | ------ | ------ | -------- | -------------- | -------------- |
| BRAM     | —      | 0      | —        | —              | 0%             |
| DSP      | —      | 14     | —        | —              | 6%             |
| LUT      | —      | 9798   | —        | —              | 18%            |
| FF       | —      | 4575   | —        | —              | 4%             |

#### 5.2.2 性能指标对比

注：II 指内核交易级启动间隔（cosim Interval），内层循环 II 见 3.2.2。

| 性能指标           | 优化前 | 优化后 | 改善幅度 |
| ------------------ | ------ | ------ | -------- |
| 初始化间隔(II)     | —      | 617 周期 | —        |
| 延迟(Latency)      | —      | 616–628 周期 | —    |
| 时钟频率           | —      | ~142.9 MHz (7 ns) | — |
| 备注               | —      | cosim 616/617；csynth 628/629 | — |

#### 5.2.3 复合性能指标

| 复合指标                        | 优化前 | 优化后 | 改善幅度 |
| ------------------------------- | ------ | ------ | -------- |
| 性能/DSP比 (示意)               | —      | 稳定吞吐/14 DSP | — |
| 吞吐量/BRAM比                   | —      | BRAM=0（理论无穷大） | — |

### 5.3 详细分析

#### 5.3.1 资源优化分析

- BRAM 优化：内部缓冲均为小深度数组，由综合推断为 LUTRAM（ram_1p/ram_2p），因此 BRAM=0；array partition 提升并发访存带宽。
- DSP 使用：复数乘法映射至 DSP，总计 14 个（约 6%），乘加并发度与时序达到平衡。
- 逻辑资源：LUT≈9798（18%）、FF≈4575（4%），主要用于控制与加法器、状态机及接口逻辑。

#### 5.3.2 性能优化分析

- 流水线效率：sum_loop 达到 II=1，列更新若干循环 II≈3；在 sqrt/div 长延迟存在下仍保持交易级 Interval≈617 周期。
- 延迟：csynth 给出 628 周期延迟（4396 ns），cosim 实测 616 周期；差异来自时序/调度边界的估计差。
- 吞吐：以 ap_fifo 流与稳定启动间隔保证持续吞吐，适度展开避免过度资源占用。

### 5.4 正确性验证

#### 5.4.1 C代码仿真结果

仿真配置：使用库自带 L1 测试，随机 SPD 复数矩阵，定点精度 ap_fixed<16,1>。

仿真结果：功能正确性通过（csim 参考输出对比通过）。

#### 5.4.2 联合仿真结果

仿真配置：Verilog/xsim，7 ns 时钟周期。

仿真结果：

- 状态：Pass（cosim 报告）
- 延迟：Latency=616 周期，Interval=617 周期
- 接口：ap_fifo + ap_ctrl_hs 行为正常

#### 5.4.3 硬件验证（如适用）

可移植到 PYNQ-Z2 平台，建议通过 AXI Stream/AXI Lite 封装与 PS 端通讯进行板级验证（本报告聚焦 HLS 级验证）。

---

## 6. 创新点总结

### 6.1 技术创新点

1. 复数定点 Cholesky 的流式实现与 LUTRAM 小缓存架构，BRAM=0；
2. 在 sqrt/div 长延迟存在下，通过轻量展开与流水线保持稳定启动间隔；
3. 针对端口带宽的 array partition 与 dependence 消除，显著改善 II。

### 6.2 LLM辅助方法创新

将 HLS 报告（Pragma/Storage/Bind）与 LLM 提示结合，形成“报告→瓶颈定位→指令组合尝试→再验证”的闭环，快速收敛在 PYNQ-Z2 上的最佳 pragma 组合。

---

## 7. 遇到的问题与解决方案

### 7.1 技术难点

| 问题描述 | 解决方案 | 效果 |
| --- | --- | --- |
| sqrt/div 长延迟导致流水受限 | 分离阶段、轻量打拍、列更新小规模展开 | Interval≈617 周期，满足 7 ns |
| 内层端口带宽不足 | 对 L_internal/diag_internal 做 cyclic 分割 | sum_loop II=1 |
| 避免 BRAM 消耗 | 小深度数组优先 LUTRAM、保持流式 | BRAM=0 |

### 7.2 LLM辅助过程中的问题

- 需要将“ II（循环级）”与“Interval（交易级）”严格区分，并在 Prompt 中明确，以免产生歧义；
- 对“是否会推断 BRAM”需结合 Storage Report 验证，避免仅凭经验判断。

---

## 8. 结论与展望

### 8.1 项目总结

完成了复数定点 Cholesky 分解的 HLS 实现，达到 BRAM=0、DSP≈6% 的资源占用，内核交易级 Interval≈617 周期（7 ns 时钟），RTL 联合仿真通过。

### 8.2 性能达成度

与目标一致：保持小资源占用与稳定吞吐；在长延迟算术单元存在下维持可接受的 II 与间隔。

### 8.3 后续改进方向

- 探索更高并行度（更大 UNROLL 因子）与数据流分段，但需评估 DSP 增长；
- 若矩阵规模增大，可考虑 URAM/BRAM 的层次化缓存与分块分解；
- 将 kernel 封装为 AXI4-Stream + AXI4-Lite IP 并完成板级验证与系统集成。

---

## 9. 参考文献

[1] AMD/Xilinx Vitis HLS 2024.2 User Guide
[2] AMD/Xilinx xf::solver Library (L1) 文档与示例
[3] Golub, G. H., & Van Loan, C. F. Matrix Computations

---

## 10. 附录

### 10.1 完整代码清单（摘要）

- 顶层内核：`solver/L1/tests/cholesky/kernel/kernel_cholesky_0.cpp`
- 类型与接口：`solver/L1/tests/cholesky/kernel/kernel_cholesky.hpp`
- 综合报告：`hls_component/hls_component/reports/hls_compile.rpt`
- 联合仿真：`hls_component/hls_component/reports/hls_cosim.rpt`

### 10.2 详细仿真报告

详见 `hls_cosim.rpt`，状态为 Pass，Latency/Interval 如上文所列。

### 10.3 关键LLM交互记录

略（关键结论已在第 4 章摘要呈现）。
