# FPGA创新设计大赛 AMD赛道命题式赛道 - 设计报告

---

## 1. 项目概述

### 1.1 项目背景

本项目基于 Vitis HLS 在 AMD PYNQ-Z2 平台上实现 3×3 复数正定矩阵的 Cholesky 分解（A = L · L^H）硬件加速核，输入来自流接口，输出为下三角矩阵 L 的流接口数据。项目以“低片上存储占用、稳定吞吐、可移植”为目标，选用定点复数数据类型以降低资源消耗。

### 1.2 设计目标

- 功能目标：
  - 支持 3×3 复数 Hermitian 正定矩阵的 Cholesky 分解，输入输出通过 AP_FIFO 流接口完成。
  - 返回运行状态码（int）。
- 性能目标：
  - 时钟周期 7 ns（≈142.9 MHz）下，单矩阵延迟 ≤ 5 μs，吞吐稳定。
  - 目标 II 低于 1k 周期/矩阵（当前为 ≈615 周期/矩阵）。
- 资源优化目标：
  - 尽可能不使用 BRAM（当前为 0）。
  - DSP 使用 ≤ 50（当前为 45），LUT ≤ 30%（当前 29%）。

### 1.3 技术规格

- 目标平台：AMD PYNQ-Z2（xc7z020-clg484-1）
- 开发工具：Vitis HLS 2024.2
- 编程语言：C/C++（HLS）
- 验证环境：C/RTL 联合仿真（xsim），HLS 报告与 JSON 指标解析

---

## 2. 设计原理和功能框图

### 2.1 算法原理

对 Hermitian 正定矩阵 A 进行 Cholesky 分解，得到下三角矩阵 L，使得 A = L · L^H。核心计算如下：

- 对角元：L[k,k] = sqrt(A[k,k] − Σ_{s=0}^{k−1} |L[k,s]|^2)
- 非对角元：L[i,k] = (A[i,k] − Σ_{s=0}^{k−1} L[i,s] · conj(L[k,s])) / L[k,k]，i>k

本设计数据类型为复数定点：x_complex<ap_fixed<16, 1>>，单元素 16 位实部 + 16 位虚部打包成 32 位。

### 2.2 系统架构设计

#### 2.2.1 顶层架构

- 输入模块：AP_FIFO 流接口读取 3×3 复数矩阵 A（9 个元素）。
- 计算核心：Cholesky 内核（包含对角与非对角更新、定点开方算子）。
- 控制模块：ap_ctrl_hs 握手协议控制启动与完成。
- 输出模块：AP_FIFO 流接口输出 3×3 下三角矩阵 L（9 个元素）。

#### 2.2.2 核心计算模块设计

- 模块A：对角元路径（diag_loop）
  - 计算 L[k,k]，调用定点 sqrt 子模块（包含迭代除法单元 sdiv）。
- 模块B：非对角更新（off_diag_loop）
  - 计算列向量 L[i,k]（i>k），使用乘加与共轭操作，适度并行与流水。
- 模块C：数据搬运与局部缓存
  - 将输入 A 缓存为本地数组（LUTRAM/ROM_NP），避免 BRAM 占用；输出 L 通过流写回。
- 上三角输出路径（Upper）：
  - 为确保数值与调度一致性，统一通过“先计算下三角 L_lower，再输出 L_upper = conj(L_lower)^T”的方式生成上三角结果（Basic/Alt 架构均已实现）。

#### 2.2.3 数据流图

输入流 A → 局部缓存/预处理 → 对角元与非对角元计算 → 后处理/格式化 → 输出流 L

### 2.3 接口设计

- 输入接口：matrixAStrm（AP_FIFO，in，32 位）
- 输出接口：matrixLStrm（AP_FIFO，out，32 位）
- 控制接口：ap_ctrl_hs（ap_start/ap_done/ap_idle/ap_ready）
- 其它端口：ap_clk（7 ns）、ap_rst、ap_return（int, 32 位）

---

## 3. 优化方向选择与原理

### 3.1 优化目标分析

- [x] 减少片上存储（BRAM）使用：当前 BRAM=0，目标维持 0。
- [x] 提升流水线性能（降低 II / 提高吞吐）：聚焦 sqrt 与列更新路径的瓶颈。
- [ ] 提高性能/资源比：在保持 DSP≤45 基础上进一步提升吞吐。

### 3.2 优化策略设计

#### 3.2.1 存储优化

- 数据重用策略：对 3×3 阵列的行/列循环重用，局部数组缓存避免重复访问。
- 存储层次优化：使用 LUTRAM/ROM_NP 实现局部表与阵列，降低 BRAM 占用（报告显示 BRAM 使用为 0）。
- 缓存设计：按列/行小片段缓存，结合 array_partition 完全/分块划分，提高并行读写带宽。

#### 3.2.2 流水线优化

- 循环展开：对小规模内层累加（k 维度 ≤3）采用小因子展开，减少循环开销。
- 流水线插入：对角与非对角路径分别 PIPELINE，使内层 II→1 或保持低位。
- 数据依赖处理：对累加与除法链路，采用分级寄存与临时数组，降低反馈依赖深度。
- C/RTL 调度一致性：在 HLS 中使用“固定迭代边界 + 条件守卫（如 if(k<j)）”取代变长循环边界，确保 C 仿真与 RTL 调度一致，避免精度偏差。

#### 3.2.3 并行化优化

- 任务级并行：顶层保持顺序（3×3 规模无需多核并行）。
- 数据级并行：对复数乘加的实部/虚部分离并行，使用多个 DSP 乘法器（总 DSP=45）。
- 指令级并行：利用加法器/选择器重叠调度，隐藏访存/控制延迟。

### 3.3 HLS 指令优化（报告中已使用）

- #pragma HLS PIPELINE（多处，包含 II=1/INNER_II 常量）
- #pragma HLS UNROLL（对短小维度循环）
- #pragma HLS ARRAY_PARTITION（对局部数组完整或分块划分）
- bind_storage/resource（库内部对 LUTRAM/URAM 的选择与提示）

---

## 4. LLM 辅助优化记录

说明：当前项目已有较成熟的库级实现与 HLS 指令，本节记录基于指标的瓶颈分析、已实施的修复与可行优化建议，供后续版本对比。

### 4.1 优化阶段一：瓶颈识别与 II 目标细化

#### 4.1.1 优化目标

- 将顶层事务间隔从 ~615 周期/矩阵进一步降低；不增加 BRAM；尽量不增加 DSP 总量。

#### 4.1.2 Prompt 设计（节选）

我在 PYNQ-Z2 上用 Vitis HLS 加速 3×3 复数 Cholesky。当前时钟 7ns，cosim 显示 Latency≈614，Interval≈615，DSP≈45，BRAM=0。请帮我分析 sqrt 子模块和列更新路径中的 II 瓶颈，并给出在不增加 BRAM 的前提下提升吞吐的具体 pragma 与代码级重构建议。

#### 4.1.3 LLM 回答（摘要）

- sqrt 路径含迭代除法（sdiv_…_50_1），导致内层 II≈50；可通过：
  - 对固定迭代步的流水展开/部分展开；
  - 采用近似/表驱动初值 + 少量迭代；
  - 以寄存/拼接的方式把前后依赖打散，使主环 II 受限更少。
- 非对角更新（off_diag）建议：
  - 对核内累加 UNROLL 小因子（=3）+ add-tree；
  - 把 L/A 局部数组做 complete/cyclic partition，确保单周期多读口；
  - 检视复数乘法器绑定到 DSP，避免落到 LUT 造成时序长路径。

#### 4.1.4 已实施变更（与修复）

- Basic 架构（`choleskyBasic`）数值路径修复：
  - 用局部 `diag_sum/off_diag_sum` 取代共享数组，避免列间相互污染；
  - 固定循环上界（到矩阵维度），用 `if (k<j)` 条件守卫实现“递减长度”的语义，保证 C/RTL 一致调度；
  - 在进入主循环前对 `L_internal` 全量零初始化，消除未定义读；
  - 非对角更新改为“累减”形式：`A[i,j] - Σ L[i,k]·conj(L[j,k])`，再除以 `real(L[j,j])`；
  - 上三角输出改为：当 `LowerTriangularL==false` 时，调用“下三角分解 + 共轭转置”生成上三角结果。
- Alt 架构（`choleskyAlt`）一致性修复：
  - 同样在 `LowerTriangularL==false` 时复用下三角路径并做共轭转置输出，避免双实现数值漂移。
- 以上改动仅触及 `solver/L1/include/hw/cholesky.hpp`，接口与外部约束不变。

---

## 5. 优化前后性能与资源对比报告

### 5.1 测试环境

- 硬件平台：AMD PYNQ-Z2（xc7z020）
- 软件版本：Vitis HLS 2024.2
- 测试数据集：随机生成的 3×3 Hermitian 正定复数矩阵（定点 16 位精度）
- 评估指标：Latency、Interval、Throughput、资源利用（DSP/LUT/FF/BRAM）、时钟频率

### 5.2 综合结果对比

注：当前仅有一版综合结果，记作“当前设计”（填入“优化后”列）；“优化前/改善幅度”留空以待后续版本对比。

#### 5.2.1 资源使用对比

| 资源类型 | 优化前 | 优化后 | 改善幅度 | 利用率(优化前) | 利用率(优化后) |
| -------- | ------ | ------ | -------- | -------------- | -------------- |
| BRAM     | —      | 0      | —        | —              | 0%             |
| DSP      | —      | 45     | —        | —              | 20%            |
| LUT      | —      | 15682  | —        | —              | 29%            |
| FF       | —      | 12060  | —        | —              | 11%            |

#### 5.2.2 性能指标对比

时钟频率：1/7ns ≈ 142.9 MHz（目标时钟周期 7 ns）

| 性能指标           | 优化前 | 优化后          | 改善幅度 |
| ------------------ | ------ | --------------- | -------- |
| 初始化间隔(II)     | —      | 615 周期/矩阵   | —        |
| 延迟(Latency)      | —      | 614 周期 ≈ 4.30 μs | —        |
| 吞吐率(Throughput) | —      | ≈ 232.4 k 矩阵/秒 | —        |
| 时钟频率           | —      | 142.9 MHz       | —        |

注：II/Latency 来源于 hls_cosim.rpt（Verilog Pass，min=avg=max）。

#### 5.2.3 复合性能指标

| 复合指标                        | 优化前 | 优化后              | 改善幅度 |
| ------------------------------- | ------ | ------------------- | -------- |
| 性能/DSP比 (矩阵每秒/DSP)       | —      | ≈ 232,400 / 45 ≈ 5,160 | —        |
| 吞吐量/BRAM比 (Throughput/BRAM) | —      | 无穷（BRAM=0）      | —        |

### 5.3 详细分析

#### 5.3.1 资源优化分析

- BRAM 优化：局部数组与查找表均为 LUTRAM/ROM_NP 实现，未使用 BRAM；适合小规模（3×3）场景。
- DSP 使用：复数乘法主要绑定 DSP，共 45 个；与 3×3 规模、流水并行度相匹配。
- 逻辑资源：LUT≈29%，FF≈11%，具备进一步提高频率或增加少量并行的余量。

#### 5.3.2 性能优化分析

- 流水线效率：cosim 显示间隔 615 周期/矩阵。报告中 sqrt 子路径存在较大迭代/除法延迟（VITIS_LOOP_143_3 含 sdiv 深度 50），对整体 II 有约束。
- 延迟组成：对角与非对角路径均为短小 tripcount（=3），但内层运算（乘加、开方）主导延迟。
- 吞吐提升方向：对内层累加与 sqrt 近似/迭代优化，或适度增加并行乘法器并使用 add-tree，可进一步降低 II。

### 5.4 正确性验证

#### 5.4.1 C/RTL 联合仿真结果

- 仿真工具：xsim
- 初始现象：对上三角输出配置的若干用例，C TB 通过，但 C/RTL 后检查存在精度不一致，典型为 test case 7，DUT_ratio=90.1385（阈值=30）。
- 原因分析：
  - Basic 路径中对角/非对角累加共享状态、可变循环边界与 RTL 调度不一致，导致数值漂移；
  - 上三角路径与下三角实现各自维护，数值细节不完全一致；
  - 内部临时阵列在部分路径未显式清零，存在未定义读风险。
- 修复措施（已实施）：
  - 用局部累加器替代共享数组，固定循环上界配合条件守卫，保证 C/RTL 一致性；
  - 将“上三角输出”统一为“下三角分解 + 共轭转置”，在 Basic/Alt 中均生效；
  - 显式零初始化 `L_internal`。
- 结果状态：
  - C TB 阶段通过；
  - C/RTL 后检查在修复前的日志仍见失败；已对 Alt 同步修复上三角路径，预计重新运行后通过；
  - 如启用 ARCH=2（Alt2），建议同样采用“先下三角后转置”的策略以保持一致性。

#### 5.4.2 硬件验证（预留）

- 计划：在 PYNQ-Z2 上通过 AXI-Stream/中断驱动完成板级回归；记录端到端吞吐与功耗。

---

## 6. 创新点总结

1. 完全去 BRAM 的小规模矩阵分解实现，充分利用 LUTRAM/ROM_NP，降低片上存储压力。
2. 复数定点 16 位 + 流接口设计，便于 SoC 侧以轻量协议供数/取数，降低 IO 压力。
3. 模块化 sqrt/列更新路径，便于后续替换更快的近似开方与 add-tree 结构做 II 优化。

---

## 7. 遇到的问题与解决方案

| 问题描述 | 解决方案 | 效果 |
| -------- | -------- | ---- |
| cosim 精度失败（上三角路径） | Basic/Alt 统一为“先下三角分解，后共轭转置”并修复局部累加/初始化/循环边界 | C TB 通过；预计 C/RTL 复核通过（Alt2 同步后） |
| sqrt 子模块迭代深 | 采用表驱动初值 + 减迭代数；或优化除法器绑定与时钟收敛 | 预期降低 II 与时延（后续实施） |
| 非对角累加的反馈依赖 | 小因子 UNROLL + add-tree，分离实/虚并行 | 预期降低关键路径（后续实施） |
| 定点精度/溢出风险 | 评估小数位，必要时扩大位宽并在接口处压缩 | 兼顾精度与资源（后续实施） |

---

## 11. 代码改动摘要（本次提交）

- 受影响文件：`solver/L1/include/hw/cholesky.hpp`
- 关键改动：
  1) Basic：
    - 使用 `diag_sum/off_diag_sum` 局部变量替代共享 `sum[]`；
    - 固定循环迭代上界并用 `if(k<j)` 条件守卫，确保 C/RTL 调度一致；
    - 新增 `L_internal` 全量零初始化；
    - 当 `LowerTriangularL==false` 时，先计算下三角，再输出上三角 `L = conj(L_lower)^T`。
  2) Alt：
    - 同样在 `LowerTriangularL==false` 时复用下三角路径并做共轭转置输出；其余数值路径保持不变。
- 接口/约束：未变更；所有更改为内部实现细节调整。

---

## 8. 结论与展望

- 当前设计在 7 ns 时钟下达到约 4.30 μs/矩阵，吞吐约 232 k 矩阵/秒，BRAM 使用为 0，DSP=45，LUT≈29%。
- 后续工作将聚焦 sqrt 与列更新路径的 II 优化，目标在不增加 BRAM 的情况下提升 10%~30% 吞吐。

---

## 9. 参考文献

[1] AMD Vitis HLS User Guide (UG1399), 2024.2 版
[2] AMD/Xilinx Vitis Libraries - Solver 模块（Cholesky）
[3] Numerical Linear Algebra 标准教材（Cholesky 分解章节）

---

## 10. 附录

### 10.1 关键文件路径

- 顶层核：`hlstrack2025/solver/L1/tests/cholesky/kernel/kernel_cholesky_0.cpp`
- HLS 报告：`hls_component/kernel_cholesky_0/reports/hls_compile.rpt`、`hls_component/kernel_cholesky_0/reports/hls_cosim.rpt`
- HLS 指标：`hls_component/kernel_cholesky_0/hls/hls_data.json`

### 10.2 接口摘要（来自报告）

- matrixAStrm：AP_FIFO in，32 位；matrixLStrm：AP_FIFO out，32 位
- ap_ctrl_hs：ap_start/ap_done/ap_idle/ap_ready
- ap_return：int, 32 位

### 10.3 重要指标（汇总）

- 时钟周期：7 ns（≈142.9 MHz）
- Latency：≈614 周期（≈4.30 μs）
- Interval：≈615 周期/矩阵
- 吞吐：≈232.4 k 矩阵/秒
- 资源：DSP=45（20%），LUT=15682（29%），FF=12060（11%），BRAM=0（0%）
