# 大模型辅助使用记录

## 基本信息

- **模型名称**：gemini-2.5-pro
- **提供方 / 访问方式**：
  - https://aistudio.google.com/prompts
- **使用日期**：2025-11-1
- **项目名称**：sha224_256 算子优化

---

## 使用场景 1

### 主要用途
分析 Vitis HLS（高层次综合）生成的 hmac_sha256 项目的综合报告，并针对其核心模块 sha224_256.hpp 的源代码，在不修改外部接口的前提下，提出具体的性能、资源和时序优化方案。

### 完整 Prompt 内容
```
================================================================
== Synthesis Summary Report of 'test_hmac_sha256'
================================================================
+ General Information: 
    * Date:           Fri Oct 31 15:27:11 2025
    * Version:        2024.2 (Build 5238294 on Nov  8 2024)
    * Project:        hmac_sha256_test.prj
    * Solution:       solution1 (Vivado IP Flow Target)
    * Product family: zynq
    * Target device:  xc7z020-clg484-1
    

+ Performance & Resource Estimates: 
    
    PS: '+' for module; 'o' for loop; '*' for dataflow
    +---------------------------------------------------------------------+------+-------+---------+-----------+----------+---------+------+----------+---------+----+-------------+-------------+-----+
    |                               Modules                               | Issue|       | Latency |  Latency  | Iteration|         | Trip |          |         |    |             |             |     |
    |                               & Loops                               | Type | Slack | (cycles)|    (ns)   |  Latency | Interval| Count| Pipelined|  BRAM   | DSP|      FF     |     LUT     | URAM|
    +---------------------------------------------------------------------+------+-------+---------+-----------+----------+---------+------+----------+---------+----+-------------+-------------+-----+
    |+ test_hmac_sha256                                                   |     -|   0.62|        -|          -|         -|        -|     -|        no|  2 (~0%)|   -|  15159 (14%)|  12839 (24%)|    -|
    | + hmacDataflow_32_64_256_32_64_sha256_wrapper_s*                    |     -|   0.62|        -|          -|         -|        -|     -|  dataflow|  2 (~0%)|   -|  15154 (14%)|  12823 (24%)|    -|
    |  + kpad_32_64_256_32_64_sha256_wrapper_s                            |     -|   6.39|        -|          -|         -|        -|     -|        no|        -|   -|    271 (~0%)|    1197 (2%)|    -|
    |   o VITIS_LOOP_118_1                                                |     -|  13.50|        -|          -|        14|        -|     -|        no|        -|   -|            -|            -|    -|
    |    + kpad_32_64_256_32_64_sha256_wrapper_Pipeline_VITIS_LOOP_120_2  |     -|   8.43|       10|    150.000|         -|       10|     -|        no|        -|   -|    263 (~0%)|     84 (~0%)|    -|
    |     o VITIS_LOOP_120_2                                              |     -|  13.50|        8|    120.000|         2|        1|     8|       yes|        -|   -|            -|            -|    -|
    |  + msgHash_32_64_256_32_64_sha256_wrapper_s*                        |     -|   0.62|        -|          -|         -|        -|     -|  dataflow|  2 (~0%)|   -|    6980 (6%)|   5761 (10%)|    -|
    |   + mergeKipad_32_64_256_64_s                                       |     -|   2.87|        -|          -|         -|        -|     -|        no|        -|   -|    1173 (1%)|     597 (1%)|    -|
    |    o VITIS_LOOP_152_1                                               |     -|  13.50|        -|          -|         -|        -|     -|        no|        -|   -|            -|            -|    -|
    |     + mergeKipad_32_64_256_64_Pipeline_VITIS_LOOP_162_2             |     -|   8.54|       18|    270.000|         -|       18|     -|        no|        -|   -|    520 (~0%)|     85 (~0%)|    -|
    |      o VITIS_LOOP_162_2                                             |     -|  13.50|       16|    240.000|         2|        1|    16|       yes|        -|   -|            -|            -|    -|
    |     + mergeKipad_32_64_256_64_Pipeline_VITIS_LOOP_171_3             |     -|   6.50|        -|          -|         -|        -|     -|        no|        -|   -|     67 (~0%)|    200 (~0%)|    -|
    |      o VITIS_LOOP_171_3                                             |     -|  13.50|        -|          -|         2|        1|     -|       yes|        -|   -|            -|            -|    -|
    |   + hash                                                            |     -|   0.62|        -|          -|         -|        -|     -|        no|        -|   -|    5451 (5%)|    4939 (9%)|    -|
    |    + sha256_top_32_256_s*                                           |     -|   0.62|        -|          -|         -|        -|     -|  dataflow|        -|   -|    5445 (5%)|    4912 (9%)|    -|
    |     + preProcessing                                                 |     -|   0.95|        -|          -|         -|        -|     -|        no|        -|   -|    1722 (1%)|    1429 (2%)|    -|
    |      o LOOP_SHA256_GENENERATE_MAIN                                  |     -|  13.50|        -|          -|        41|        -|     -|        no|        -|   -|            -|            -|    -|
    |       + preProcessing_Pipeline_LOOP_SHA256_GEN_FULL_BLKS            |     -|   6.14|       18|    270.000|         -|       18|     -|        no|        -|   -|    559 (~0%)|    312 (~0%)|    -|
    |        o LOOP_SHA256_GEN_FULL_BLKS                                  |     -|  13.50|       16|    240.000|        17|       16|     1|       yes|        -|   -|            -|            -|    -|
    |       + preProcessing_Pipeline_LOOP_SHA256_GEN_COPY_TAIL_AND_ONE    |     -|   7.80|       16|    240.000|         -|       16|     -|        no|        -|   -|    454 (~0%)|     579 (1%)|    -|
    |        o LOOP_SHA256_GEN_COPY_TAIL_AND_ONE                          |     -|  13.50|       14|    210.000|         2|        1|    14|       yes|        -|   -|            -|            -|    -|
    |     + dup_strm                                                      |     -|   6.05|        6|     90.000|         -|        6|     -|        no|        -|   -|     16 (~0%)|    253 (~0%)|    -|
    |      + dup_strm_Pipeline_VITIS_LOOP_506_1                           |     -|   6.05|        3|     45.000|         -|        3|     -|        no|        -|   -|      8 (~0%)|    119 (~0%)|    -|
    |       o VITIS_LOOP_506_1                                            |     -|  13.50|        1|     15.000|         2|        1|     1|       yes|        -|   -|            -|            -|    -|
    |     + generateMsgSchedule                                           |     -|   4.99|        -|          -|         -|        -|     -|        no|        -|   -|    1822 (1%)|     852 (1%)|    -|
    |      o VITIS_LOOP_528_1                                             |     -|  13.50|        -|          -|         -|        -|     -|        no|        -|   -|            -|            -|    -|
    |       o VITIS_LOOP_530_2                                            |     -|  13.50|        -|          -|        73|        -|     -|        no|        -|   -|            -|            -|    -|
    |        + generateMsgSchedule_Pipeline_LOOP_SHA256_PREPARE_WT16      |     -|   8.54|       18|    270.000|         -|       18|     -|        no|        -|   -|    552 (~0%)|    141 (~0%)|    -|
    |         o LOOP_SHA256_PREPARE_WT16                                  |     -|  13.50|       16|    240.000|         2|        1|    16|       yes|        -|   -|            -|            -|    -|
    |        + generateMsgSchedule_Pipeline_LOOP_SHA256_PREPARE_WT64      |     -|   4.99|       50|    750.000|         -|       50|     -|        no|        -|   -|    555 (~0%)|     453 (~0%)|    -|
    |         o LOOP_SHA256_PREPARE_WT64                                  |     -|  13.50|       48|    720.000|         2|        1|    48|       yes|        -|   -|            -|            -|    -|
    |     + sha256Digest_256_s                                            |     -|   0.62|        -|          -|         -|        -|     -|        no|        -|   -|    1093 (1%)|    1694 (3%)|    -|
    |      o LOOP_SHA256_DIGEST_MAIN                                      |     -|  13.50|        -|          -|        73|        -|     -|        no|        -|   -|            -|            -|    -|
    |       o LOOP_SHA256_DIGEST_NBLK                                     |     -|  13.50|       71|  1.065e+03|        71|        -|     1|        no|        -|   -|            -|            -|    -|
    |        + sha256Digest_256_Pipeline_LOOP_SHA256_UPDATE_64_ROUNDS     |     -|   0.62|       68|  1.020e+03|         -|       68|     -|        no|        -|   -|    637 (~0%)|    1375 (2%)|    -|
    |         o LOOP_SHA256_UPDATE_64_ROUNDS                              |     -|  13.50|       66|    990.000|         4|        1|    64|       yes|        -|   -|            -|            -|    -|
    |  + resHash_32_64_256_32_64_sha256_wrapper_s*                        |     -|   0.62|        -|          -|         -|        -|     -|  dataflow|        -|   -|    7309 (6%)|   5455 (10%)|    -|
    |   + mergeKopad_32_64_256_32_64_s                                    |     -|   6.23|        -|          -|         -|        -|     -|        no|        -|   -|    1561 (1%)|    310 (~0%)|    -|
    |    o VITIS_LOOP_213_1                                               |     -|  13.50|        -|          -|        33|        -|     -|        no|        -|   -|            -|            -|    -|
    |     + mergeKopad_32_64_256_32_64_Pipeline_VITIS_LOOP_220_2          |     -|   8.54|       18|    270.000|         -|       18|     -|        no|        -|   -|    520 (~0%)|     85 (~0%)|    -|
    |      o VITIS_LOOP_220_2                                             |     -|  13.50|       16|    240.000|         2|        1|    16|       yes|        -|   -|            -|            -|    -|
    |     + mergeKopad_32_64_256_32_64_Pipeline_VITIS_LOOP_226_3          |     -|   8.59|       10|    150.000|         -|       10|     -|        no|        -|   -|    263 (~0%)|     84 (~0%)|    -|
    |      o VITIS_LOOP_226_3                                             |     -|  13.50|        8|    120.000|         2|        1|     8|       yes|        -|   -|            -|            -|    -|
    |   + hash_1                                                          |     -|   0.62|        -|          -|         -|        -|     -|        no|        -|   -|    5451 (5%)|    4939 (9%)|    -|
    |    + sha256_top_32_256_s*                                           |     -|   0.62|        -|          -|         -|        -|     -|  dataflow|        -|   -|    5445 (5%)|    4912 (9%)|    -|
    |     + preProcessing                                                 |     -|   0.95|        -|          -|         -|        -|     -|        no|        -|   -|    1722 (1%)|    1429 (2%)|    -|
    |      o LOOP_SHA256_GENENERATE_MAIN                                  |     -|  13.50|        -|          -|        41|        -|     -|        no|        -|   -|            -|            -|    -|
    |       + preProcessing_Pipeline_LOOP_SHA256_GEN_FULL_BLKS            |     -|   6.14|       18|    270.000|         -|       18|     -|        no|        -|   -|    559 (~0%)|    312 (~0%)|    -|
    |        o LOOP_SHA256_GEN_FULL_BLKS                                  |     -|  13.50|       16|    240.000|        17|       16|     1|       yes|        -|   -|            -|            -|    -|
    |       + preProcessing_Pipeline_LOOP_SHA256_GEN_COPY_TAIL_AND_ONE    |     -|   7.80|       16|    240.000|         -|       16|     -|        no|        -|   -|    454 (~0%)|     579 (1%)|    -|
    |        o LOOP_SHA256_GEN_COPY_TAIL_AND_ONE                          |     -|  13.50|       14|    210.000|         2|        1|    14|       yes|        -|   -|            -|            -|    -|
    |     + dup_strm                                                      |     -|   6.05|        6|     90.000|         -|        6|     -|        no|        -|   -|     16 (~0%)|    253 (~0%)|    -|
    |      + dup_strm_Pipeline_VITIS_LOOP_506_1                           |     -|   6.05|        3|     45.000|         -|        3|     -|        no|        -|   -|      8 (~0%)|    119 (~0%)|    -|
    |       o VITIS_LOOP_506_1                                            |     -|  13.50|        1|     15.000|         2|        1|     1|       yes|        -|   -|            -|            -|    -|
    |     + generateMsgSchedule                                           |     -|   4.99|        -|          -|         -|        -|     -|        no|        -|   -|    1822 (1%)|     852 (1%)|    -|
    |      o VITIS_LOOP_528_1                                             |     -|  13.50|        -|          -|         -|        -|     -|        no|        -|   -|            -|            -|    -|
    |       o VITIS_LOOP_530_2                                            |     -|  13.50|        -|          -|        73|        -|     -|        no|        -|   -|            -|            -|    -|
    |        + generateMsgSchedule_Pipeline_LOOP_SHA256_PREPARE_WT16      |     -|   8.54|       18|    270.000|         -|       18|     -|        no|        -|   -|    552 (~0%)|    141 (~0%)|    -|
    |         o LOOP_SHA256_PREPARE_WT16                                  |     -|  13.50|       16|    240.000|         2|        1|    16|       yes|        -|   -|            -|            -|    -|
    |        + generateMsgSchedule_Pipeline_LOOP_SHA256_PREPARE_WT64      |     -|   4.99|       50|    750.000|         -|       50|     -|        no|        -|   -|    555 (~0%)|     453 (~0%)|    -|
    |         o LOOP_SHA256_PREPARE_WT64                                  |     -|  13.50|       48|    720.000|         2|        1|    48|       yes|        -|   -|            -|            -|    -|
    |     + sha256Digest_256_s                                            |     -|   0.62|        -|          -|         -|        -|     -|        no|        -|   -|    1093 (1%)|    1694 (3%)|    -|
    |      o LOOP_SHA256_DIGEST_MAIN                                      |     -|  13.50|        -|          -|        73|        -|     -|        no|        -|   -|            -|            -|    -|
    |       o LOOP_SHA256_DIGEST_NBLK                                     |     -|  13.50|       71|  1.065e+03|        71|        -|     1|        no|        -|   -|            -|            -|    -|
    |        + sha256Digest_256_Pipeline_LOOP_SHA256_UPDATE_64_ROUNDS     |     -|   0.62|       68|  1.020e+03|         -|       68|     -|        no|        -|   -|    637 (~0%)|    1375 (2%)|    -|
    |         o LOOP_SHA256_UPDATE_64_ROUNDS                              |     -|  13.50|       66|    990.000|         4|        1|    64|       yes|        -|   -|            -|            -|    -|
    +---------------------------------------------------------------------+------+-------+---------+-----------+----------+---------+------+----------+---------+----+-------------+-------------+-----+
以上是仿真报告，以下是sha224_256.hpp代码：
/*
 * Copyright 2019 Xilinx, Inc.
 * ... (sha224_256.hpp 文件的完整内容) ...
 */
在不能修改外部接口的前提下有什么可优化的地方？指出如何修改代码。
```

### 模型输出摘要
模型首先分析了报告和代码，指出当前设计虽然性能不错（核心计算循环 II=1），但存在 **资源占用过高** 和 **时序紧张** (Slack=0.62ns) 的问题。

在用户明确 **不能修改外部接口** 的前提下，模型给出了两类核心优化建议：

1. **资源优化 (首要建议)**:
   - **问题**: 代码中过度使用了 #pragma HLS unroll，尤其是在 preProcessing 函数的非关键路径（如消息末尾的填充逻辑）和利用率不高的主数据加载循环中，导致生成了大量非必要的并行硬件。
   - **解决方案**: 将这些地方的 #pragma HLS unroll 修改为 #pragma HLS pipeline II=1。这会使用一套硬件来串行完成任务，在不影响整体吞吐率的前提下，**大幅减少 LUT 和 FF 资源占用**。
2. **时序优化**:
   - **问题**: 时序报告显示 Slack 值很低 (0.62ns)，表明关键路径的逻辑延迟过长，很可能在 sha256_iter 函数的 T1 变量计算中。
   - **解决方案**: 采用 **"表达式平衡" (Expression Balancing)** 的方法，手动将计算 T1 的长表达式 (T1 = h + BSIG1(e) + CH(e, f, g) + Kt + Wt;) 分解为多个中间步骤。这能帮助 HLS 工具更好地调度逻辑，缩短关键路径，从而 **增加时序裕量 (Slack)**，使设计更稳定或能运行在更高频率。

### 人工审核与采纳情况
- **已采纳的建议**:
  1. **资源优化**: 采纳了将 preProcessing 函数中多个非性能关键循环的 #pragma HLS unroll 指令修改为 #pragma HLS pipeline II=1 的建议。这包括了对消息尾部填充逻辑和主数据加载逻辑的修改。
  2. **时序优化**: 采纳了在 sha256_iter 函数中分解 T1 计算表达式的建议，以改善时序性能。
- **未采纳的建议**:
  1. **修改接口位宽**: 模型最初提出的将输入流 msgStrm 宽度从32位增加到512位的建议未被采纳，因为这违反了“不能修改外部接口”的约束条件。
- **二次验证与仿真**:
  1. 在应用上述代码修改后，已重新运行 **C 综合 (C Synthesis)** 以生成新的性能和资源报告。

---

## 使用场景 2

### 主要用途
指导如何查看和解读 Vitis 报告。

### 完整 Prompt 内容
```
现在我想cosim和csim报告如何理解，应该着重注意哪些部分？
```

### 模型输出摘要
模型清晰地解释了两种核心仿真的区别与用途：

1. **C 仿真 (CSIM)**: 用于快速验证算法逻辑的正确性。
2. **C/RTL 协同仿真 (Co-simulation)**: 用于验证综合后硬件行为的正确性，并提供 **精确的性能数据（延迟周期数）**。

### 人工审核与采纳情况
- **采纳情况说明**:

  - 这是一个指导性的说明，其内容被完全采纳作为后续验证步骤的操作指南。

  - 用户根据此指南，能够理解需要通过运行 **C/RTL 协同仿真** 来验证代码修改后的硬件功能是否正确，并获取最终的性能指标。

## 使用场景 3

### 主要用途

探索 SHA256 算法的更细微处的优化。初期利用大模型获取通用的性能调优技巧，但最终独立设计并实现了一种更高效的自定义流水线调度方案。

### 完整 Prompt 内容

```
分析所附的 sha224_256.hpp 代码，特别是 generateMsgSchedule 和 sha256Digest 这两个函数。当前 generateMsgSchedule 的 LOOP_SHA256_PREPARE_WT64 循环延迟较高。有没有可能将消息调度（W_t 的计算）和摘要计算（64轮更新）更深度地融合，而不是作为两个独立的数据流单元？例如，在需要 W_t 的前一刻才计算它，而不是提前全部算完。请分析这种策略的可行性和潜在优缺点。
```

### 模型输出摘要

模型分析了“即时计算”策略，并给出了如下结论：

- **可行性**: 理论上可行。W_t 的计算依赖于 W_{t-16}, W_{t-15}, W_{t-7}, W_{t-2}。在第 t 轮摘要计算时，这些值都是已知的。
- **优点**: 可能会减少存储 W 数组所需的寄存器资源，并降低数据流中w_strm的深度，从而节省 BRAM 或 LUTRAM 资源。
- **缺点**: W_t 的计算（包含多次移位和加法）与 T1 的计算（同样是复杂的多输入加法）耦合在同一个流水线阶段，可能会形成一个 **更长的关键路径**，从而恶化时序（降低 Slack），导致无法达到II=1的目标。模型建议谨慎尝试，并优先考虑时序收敛。


### 人工审核与采纳情况

- **采纳情况说明**:
  - 我采纳了模型关于 **可行性** 的分析，确认了数据依赖关系允许这种融合。
  - 然而，我 **并未采纳** 模型关于“时序可能恶化”的悲观预测，并认为这是一个创新点。
  - 创新:
    1. 我没有直接将 W_t 的计算和摘要计算放在同一周期，而是设计了一个小流水线：在第 t 周期，预计算第 t+1 轮所需的 W_{t+1}，同时执行第 t 轮的摘要更新。
    2. 这种“交错执行”的微架构设计，既移除 generateMsgSchedule 和 sha256Digest 之间的大容量 FIFO (w_strm)，显著降低了资源和延迟，又通过流水线切分，规避了时序恶化的问题，依然保持了II=1。
  - **结论**: 模型提供了初步的可行性分析，解决了模型所担心的时序瓶颈，实现了优于传统数据流方法的资源和延迟表现。

---

## 总结

### 整体贡献度评估
- 大模型在本项目中的总体贡献占比：约 50%
- 主要帮助领域：代码优化与错误分析 / 文档撰写 
- 人工介入与修正比例：约 75%


### 学习收获
通过与大模型交互，我不仅解决了当前项目的问题，更在方法论上获得了显著提升：

1. **HLS 性能分析方法论**: 我学会了如何系统性地解读 HLS 报告，将报告中的数据（如II=16的瓶颈、Slack过小的时序风险）与源代码中的具体循环和表达式对应起来，形成了从报告到代码的精准定位能力。
2. **资源与性能的权衡艺术**: 我深刻理解了#pragma HLS unroll和#pragma HLS pipeline在性能和资源占用上的根本区别。通过本次实践，我掌握了在非关键路径上使用pipeline替代unroll以大幅节省资源的实用技巧。
3. **时序优化的微观技巧**: 学习并实践了“表达式平衡”这一时序优化技术。这让我认识到，在 HLS 设计中，编写对综合工具友好的代码（如避免过长的组合逻辑链）是提升设计最高频率的关键。
4. **工程验证流程**: 本次交互也强化了我对 HLS 开发流程的理解，明确了“代码修改 -> **重新综合** -> 协同仿真”这一验证优化效果的必要步骤。

---

## 附注

- 请确保填写真实、完整的使用记录
- 如未使用大模型辅助，请在此文件中注明"本项目未使用大模型辅助"
- 评审方将参考此记录了解项目的独立性与创新性
